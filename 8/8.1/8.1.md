# 8.1. Sentencias SQL por módulo / prototipo

# Módulo 5: Gestión de inventario
## Ingreso de insumos: Funcionalidad
### Nuevo producto
Cod requerimiento:

Pantalla:

![alt text](image.png)

Sentencia SQL:

```sql 
INSERT INTO insumo (cod_categoriainsumo, cod_subcategoria, nombre_insumo, cod_unidad, cod_condiciones, cantidad_total, umbral)
SELECT 
    ci.cod_categoriainsumo,
    s.cod_subcategoria,
    '<3>',
    um.cod_unidad,
    c.cod_condiciones,
    0,  -- Siempre es 0
    20
FROM 
    categoria_insumo ci
JOIN 
    subcategoria s ON s.nombre_subcategoria = '<2>'
JOIN 
    unidad_medidad um ON um.nombre_unidad = '<4>'
JOIN 
    condiciones c ON c.nombre_condiciones = '<5>'
WHERE 
    ci.nombre_categoriainsumo = '<1>';
```

### Revisión cantidad

Ver cantidades solicitadas y recibidas:
```sql
SELECT 
    i.nombre_insumo, 
    um.nombre_unidad as "Unidad de medida", 
    oc2.cantidad_compra as "Cantidad solicitada", 
    rc.cantidad_revisada as "Cantidad de la revisión", 
    concat(e.primer_nombre, e.primer_apellido, e.segundo_apellido) AS supervisor_nombre
FROM 
    orden_compra oc
left JOIN 
    orden_comprainsumo oc2 ON oc2.cod_ordencompra = oc.cod_ordencompra 
left JOIN 
    revision_cantidad rc ON rc.cod_ordencompra = oc.cod_ordencompra 
    AND rc.cod_insumo = oc2.cod_insumo
left JOIN insumo i ON oc2.cod_insumo = i.cod_insumo 
left JOIN unidad_medidad um ON um.cod_unidad = i.cod_unidad 
left JOIN empleado e ON rc.cod_supervisor = e.codigo_empleado 
WHERE oc.cod_ordencompra = 18;
```

Agregar cantidad recibida:
```sql
UPDATE Revision_Cantidad rc
SET cantidad_revisada = <>
FROM Orden_comprainsumo oc2
WHERE 
    rc.cod_ordencompra = oc2.cod_ordencompra
    AND rc.cod_insumo = oc2.cod_insumo
    AND oc2.cod_ordencompra = '<cod_ordencompra>'
    AND oc2.Cod_Insumo = <>;
```

### Revisión calidad

Ver insumos de la orden de compra
```sql
SELECT 
    i.nombre_insumo,  
    concat(e.primer_nombre, e.primer_apellido, e.segundo_apellido) AS "Nombre del supervisor",
    c.estado,
    rc.descripcion
FROM 
    orden_compra oc
left JOIN 
    orden_comprainsumo oc2 ON oc2.cod_ordencompra = oc.cod_ordencompra 
left JOIN 
    revision_calidad rc on rc.cod_ordencompra = oc.cod_ordencompra 
    AND rc.cod_insumo = oc2.cod_insumo
left JOIN insumo i ON oc2.cod_insumo = i.cod_insumo 
left join calidad c on rc.cod_calidad = c.cod_calidad 
left JOIN empleado e ON rc.cod_supervisor = e.codigo_empleado 
WHERE oc.cod_ordencompra = 18;
```

Agregar calidad y descripción:

```sql
UPDATE revision_calidad rc
SET Cod_calidad = c.cod_calidad,
descripcion = '<>'
FROM Orden_comprainsumo oc2
JOIN calidad c ON c.estadp = '<>'
WHERE 
    oc2.cod_ordencompra = rc.cod_ordencompra
    AND rc.cod_insumo = oc2.cod_insumo
    AND oc2.cod_ordencompra = '<>'
    AND oc2.Cod_Insumo = <>;
```


### Seleccionar ubicación en almacén
Ver insumos en orden de compra y condiciones de almacenamiento
```sql
select oc.cod_ordencompra, i.nombre_insumo, rc.cantidad_revisada, c.nombre_condiciones from orden_comprainsumo oc 
inner join insumo i ON oc.cod_insumo =i.cod_insumo 
inner join revision_cantidad rc on rc.cod_ordencompra = oc.cod_ordencompra
inner join condiciones c on c.cod_condiciones = i.cod_condiciones 
where oc.cod_ordencompra = '1'
```

Ver almacenes disponibles
```sql
select a.nombre_almacen, ta.nombre_tipo_almacen, a.Cantidad_actual, a.Cantidad_actual, l.nombre_local from almacen a 
inner join "local" l on a.cod_local = l.cod_local
inner join empleado e on a.cod_local = e.cod_local 
inner join tipo_almacen ta on ta.cod_tipo_almacen = a.cod_tipo_almacen 
where a.cod_local = 1
```


## Elaboración de hoja de producción
Creación de la hoja de producción:
```sql
insert into hojaproduccion (fecha_elaboracion, codigo_empleado)
values (current_date, 102)
```
Modificación de la hoja de producción:
```sql
insert into incluye (cantidad, cod_hoja, cod_prodfriday)
values (1, 
(select h.cod_hoja from hojaproduccion h where h.fecha_elaboracion = current_date),
(select pf.cod_prodfriday from producto_friday pf where pf.cod_prodfriday = 'APP1000001')
)
```

Generación de lista de insumos a retirar:
```sql
select 
    i.Cod_Insumo,
    i.Nombre_Insumo,
    SUM(se.Cantidad_Receta) AS Cantidad_Necesaria
from HojaProduccion h
inner join Incluye inc ON h.Cod_Hoja = inc.Cod_Hoja
inner join SeConviertenEn se ON inc.Cod_prodFriday = se.Cod_Producto
inner join Insumo i ON se.Cod_Insumo = i.Cod_Insumo
where h.Cod_Hoja = (select h.cod_hoja from hojaproduccion h where h.fecha_elaboracion = current_date)
group by h.Cod_Hoja, i.Cod_Insumo, i.Nombre_Insumo
order by Cantidad_Necesaria desc
```

Ver listas pasadas

```sql
select 
    i.Cod_Insumo,
    i.Nombre_Insumo,
    SUM(se.Cantidad_Receta) AS Cantidad_Necesaria
from HojaProduccion h
inner join Incluye inc ON h.Cod_Hoja = inc.Cod_Hoja
inner join SeConviertenEn se ON inc.Cod_prodFriday = se.Cod_Producto
inner join Insumo i ON se.Cod_Insumo = i.Cod_Insumo
where h.Cod_Hoja = 1
group by h.Cod_Hoja, i.Cod_Insumo, i.Nombre_Insumo
order by Cantidad_Necesaria DESC
```

## Revisar inventario
Inventario extendido:

```sql
select ci.nombre_categoriainsumo, s.nombre_subcategoria, i.cod_insumo, i.nombre_insumo,
um.nombre_unidad, s2.cantidad, ta.nombre_tipo_almacen, a.cod_almacen ,l.nombre_local, s2.fecha_vencimiento,
p.nombre_empresa, s2.cod_stock 
from insumo i 
inner join categoria_insumo ci on ci.cod_categoriainsumo = i.cod_categoriainsumo 
inner join subcategoria s on s.cod_subcategoria = i.cod_subcategoria 
inner join unidad_medidad um on um.cod_unidad = i.cod_unidad 
inner join stock s2 on i.cod_insumo =s2.cod_insumo
inner join almacen a on a.cod_almacen = s2.cod_almacen
inner join "local" l on l.cod_local = a.cod_local
inner join tipo_almacen ta on ta.cod_tipo_almacen = a.cod_almacen
inner join proveedor p on p.cod_proveedor = s2.cod_proveedor
where l.cod_local = <4>
and (ci.cod_categoriainsumo = COALESCE('<1>', ci.cod_categoriainsumo))
and (s.Cod_subcategoria = COALESCE('<2>', s.Cod_subcategoria))
and (i.Nombre_Insumo ILIKE COALESCE('%' || '<3>' || '%', '%'));
```

Inventario "compacto"
```sql

SELECT 
    i.cod_insumo, 
    i.nombre_insumo,
    ci.nombre_categoriainsumo,
    s.nombre_subcategoria,
    um.nombre_unidad,
    SUM(s2.cantidad) AS Cantidad_total,  -- Sumar las cantidades de stock
    l.nombre_local
FROM 
    insumo i 
INNER JOIN 
    categoria_insumo ci ON ci.cod_categoriainsumo = i.cod_categoriainsumo 
INNER JOIN 
    subcategoria s ON s.cod_subcategoria = i.cod_subcategoria 
INNER JOIN 
    unidad_medidad um ON um.cod_unidad = i.cod_unidad 
INNER JOIN 
    stock s2 ON i.cod_insumo = s2.cod_insumo
INNER JOIN 
    almacen a ON a.cod_almacen = s2.cod_almacen
INNER JOIN 
    "local" l ON l.cod_local = a.cod_local
INNER JOIN 
    tipo_almacen ta ON ta.cod_tipo_almacen = a.cod_tipo_almacen
INNER JOIN 
    proveedor p ON p.cod_proveedor = s2.cod_proveedor
WHERE 
    l.cod_local = <>
GROUP BY 
    i.cod_insumo, 
    i.nombre_insumo,
    ci.nombre_categoriainsumo,
    s.nombre_subcategoria,
    um.nombre_unidad,
    ta.nombre_tipo_almacen,
    l.nombre_local,
    p.nombre_empresa
ORDER BY Cantidad_total DESC;

```

# Modulo 4: Gestion de personal y turno

### Página pricipal

<table border="1" cellpadding="5" cellspacing="0">
    <tr>
        <td><strong>Código Requerimiento</strong></td>
        <td>CU001</td>
    </tr>
    <tr>
        <td><strong>Código Interfaz</strong></td>
        <td>I04</td>
    </tr>
    <tr>
        <td><strong>Imagen Interfaz</strong></td>
        <td>
            <img src="../8.1/Imagenes_modulo4/Página_principal.jpg" alt="Página principal" >
        </td>
    </tr>
    <tr>
        <td><strong>Sentencias SQL</strong></td>
        <td></td>
    </tr>
    <tr>
        <td><strong>Eventos</strong></td>
        <td>
            <ol>
                <li>
                    <strong>Trabajadores activos: </strong> Se muestra la cantidad de trabajadores que marcaron su asistencia y están laborando en el día.<br>
                    <code>SELECT COUNT(cod_asistencia) AS "Total activos"
                    FROM ASISTENCIA 
                    WHERE cod_estado in (1,3) and 
                    fecha=CURRENT_DATE;</code>
                </li>
                <li>
                    <strong>Solicitudes: </strong> Se muestra la cantidad de solicitudes no revisadas ni procesadas.<br>
                    <code>SELECT COUNT(cod_sd) AS "Total solicitudes"
                    FROM SOLICITUD_O_DESCARGO
                    WHERE cod_estado_sd=1;
                    </code>
                </li>
            </ol>
        </td>
    </tr>
</table>
Sample content for section 8.1.

