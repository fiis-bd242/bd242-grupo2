# 10.1. Listado de Procesos Batch

### Generación de Nómina Automática al Final de Mes

El siguiente proceso describe cómo automatizar la generación de nómina al final de cada mes utilizando PostgreSQL. Este flujo incluye:  
1. **Creación de una tabla** para almacenar la información de la nómina generada.  
2. **Ejecución de una consulta SQL** para calcular las horas trabajadas y extras de los empleados.  
3. **Programación automática del proceso** utilizando el módulo `pg_cron` nativo de PostgreSQL.

---

#### 1. Creación de la tabla `Nomina`

Esta tabla almacena los datos generados por la nómina mensual, incluyendo la fecha de generación, el nombre del empleado, su identificación, el cargo, las horas trabajadas y las horas extra.

```sql
CREATE TABLE Nomina
(
    Fecha_generacion DATE NOT NULL,
    Nombre_empleado VARCHAR(200) NOT NULL,
    DNI CHAR(8) NOT NULL,
    Cargo VARCHAR(50) NOT NULL,
    Horas_trabajadas NUMERIC(10, 2) NOT NULL,
    Horas_extra NUMERIC(10, 2) NOT NULL,
    PRIMARY KEY (Fecha_generacion, DNI)
);
```

---

#### 2. Procedimiento SQL para generar la nómina

Este procedimiento se ejecutará cada fin de mes y almacenará los resultados en la tabla `Nomina`. La consulta calcula las horas trabajadas y las horas extra por empleado durante el mes anterior.

```sql
INSERT INTO Nomina (Fecha_generacion, Nombre_empleado, DNI, Cargo, Horas_trabajadas, Horas_extra)
SELECT 
    CURRENT_DATE AS Fecha_generacion,
    e.Primer_nombre || ' ' || e.Primer_apellido AS Nombre_empleado,
    e.DNI,
    c.Nombre_cargo AS Cargo,
    SUM(
        EXTRACT(EPOCH FROM (a.Hora_salida - a.Hora_ingreso)) / 3600  
    ) AS Horas_trabajadas,
    SUM(
        CASE
            WHEN a.Hora_salida > t.Hora_fin THEN
                EXTRACT(EPOCH FROM (a.Hora_salida - t.Hora_fin)) / 3600  
            ELSE 0
        END
    ) AS Horas_extra
FROM 
    Empleado e
JOIN 
	Registra r ON e.codigo_empleado = r.codigo_empleado
JOIN
    Asistencia a ON r.Cod_asistencia = a.Cod_asistencia
JOIN 
    Turno t ON e.Cod_turno = t.Cod_turno 
JOIN 
    Cargo c ON e.Cod_cargo = c.Cod_cargo  
WHERE 
    a.Fecha >= DATE_TRUNC('month', CURRENT_DATE) - INTERVAL '1 MONTH' 
    AND a.Fecha < DATE_TRUNC('month', CURRENT_DATE)
GROUP BY 
    e.Primer_nombre, e.Primer_apellido, e.DNI, c.Nombre_cargo;
```

---

#### 3.A. Programación del proceso con `pg_cron`

`pg_cron` es una extensión de PostgreSQL que permite programar tareas automáticas dentro de la base de datos. A continuación, se configura un job que se ejecutará al final de cada mes para generar la nómina.

```sql
SELECT cron.schedule('Generar_Nomina', 
                     '59 23 28-31 * *',  -- Ejecuta cerca de la medianoche al final del mes.
                     $$ INSERT INTO Nomina (
                            Fecha_generacion,
                            Nombre_empleado,
                            DNI,
                            Cargo,
                            Horas_trabajadas,
                            Horas_extra
                        )
                        SELECT 
                            CURRENT_DATE AS Fecha_generacion,
                            e.Primer_nombre || ' ' || e.Primer_apellido AS Nombre_empleado,
                            e.DNI,
                            c.Nombre_cargo AS Cargo,
                            SUM(
                                EXTRACT(EPOCH FROM (a.Hora_salida - a.Hora_ingreso)) / 3600  
                            ) AS Horas_trabajadas,
                            SUM(
                                CASE
                                    WHEN a.Hora_salida > t.Hora_fin THEN
                                        EXTRACT(EPOCH FROM (a.Hora_salida - t.Hora_fin)) / 3600  
                                    ELSE 0
                                END
                            ) AS Horas_extra
                        FROM 
                            Empleado e
                        JOIN 
                            Registra r ON e.codigo_empleado = r.codigo_empleado
                        JOIN
                            Asistencia a ON r.Cod_asistencia = a.Cod_asistencia
                        JOIN 
                            Turno t ON e.Cod_turno = t.Cod_turno 
                        JOIN 
                            Cargo c ON e.Cod_cargo = c.Cod_cargo  
                        WHERE 
                            a.Fecha >= DATE_TRUNC('month', CURRENT_DATE) - INTERVAL '1 MONTH' 
                            AND a.Fecha < DATE_TRUNC('month', CURRENT_DATE)
                        GROUP BY 
                            e.Primer_nombre, e.Primer_apellido, e.DNI, c.Nombre_cargo; $$);
```

